<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div th:replace="include/header::front"></div>

<h1 th:text="${post.title}">게시글 제목</h1>
<p th:text="${post.content}">게시글 내용</p>

<div id="postDetails"
     th:data-has-edit-permission="${hasEditPermission}"
     th:data-can-reply="${canReply}"
     th:data-board-idx="${boardIdx}"
     th:data-post-idx="${post.idx}">
</div>

<div class="button-container">
    <button type="button" id="editButton" class="btn btn-primary" style="display:none;">수정</button>
    <button type="button" id="replyButton" class="btn btn-success" style="display:none;">답글쓰기</button>
    <button type="button" id="deleteButton" class="btn btn-danger" style="display:none;">삭제</button>
    <button type="button" id="listButton" class="btn btn-secondary">
        목록 <i class="fas fa-list"></i>
    </button>
</div>

<div th:replace="include/footer::front"></div>

<script>
    $(document).ready(function() {
        // 데이터 속성에서 변수 값 읽기
        var postDetails = $('#postDetails');
        var hasEditPermission = postDetails.data('has-edit-permission');
        var canReply = postDetails.data('can-reply');
        var boardIdx = postDetails.data('board-idx');
        var postIdx = postDetails.data('post-idx');

        // 수정 권한이 있을 때 수정 버튼 표시 및 클릭 시 동작
        if (hasEditPermission) {
            $('#editButton').show().on('click', function() {
                window.location.href = '/front/board/' + boardIdx + '/post/' + postIdx + '/edit';
            });

            $('#deleteButton').show().on('click', function() {
                Swal.fire({
                    title: '정말 삭제하시겠습니까?',
                    text: "삭제하면 복구할 수 없습니다!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '삭제',
                    cancelButtonText: '취소'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('/front/board/post/' + postIdx + '/delete', function(response) {
                            Swal.fire(
                                '삭제 완료!',
                                '게시글이 삭제되었습니다.',
                                'success'
                            ).then(() => {
                                window.location.href = '/front/board/' + boardIdx + '/posts';
                            });
                        }).fail(function(error) {
                            Swal.fire({
                                icon: 'error',
                                title: '삭제 실패',
                                text: error.responseJSON.error || error.statusText,
                                confirmButtonText: '확인'
                            });
                        });
                    }
                });
            });
        } else {
            $('#editButton, #deleteButton').show().click(function() {
                Swal.fire({
                    icon: 'warning',
                    title: '권한 없음',
                    text: '수정 또는 삭제 권한이 없습니다.',
                    confirmButtonText: '확인'
                });
            });
        }

        // 답글 작성 권한이 있을 때 답글쓰기 버튼 표시 및 클릭 시 동작
        if (canReply) {
            $('#replyButton').show().on('click', function() {
                window.location.href = '/front/board/' + boardIdx + '/post/' + postIdx + '/reply';
            });
        } else {
            $('#replyButton').show().click(function() {
                Swal.fire({
                    icon: 'warning',
                    title: '권한 없음',
                    text: '답글 작성 권한이 없습니다.',
                    confirmButtonText: '확인'
                });
            });
        }

        // 목록 버튼 클릭 시 게시글 목록 페이지로 이동
        $("#listButton").on('click', function() {
            window.location.href = '/front/board/' + boardIdx + '/posts';
        });
    });
</script>
</body>
</html>